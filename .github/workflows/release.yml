name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    env:
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: latest

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run bundle

      - name: Test
        run: bun run test

      - name: Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        with:
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/git
            @semantic-release/exec
            semantic-release-vsce
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
          OVSX_PAT: ${{ secrets.OVSX_TOKEN }}

      - name: Publish Universal VSIX
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          bunx vsce publish --packagePath dist/stata-workbench-${{ steps.semantic.outputs.new_release_version }}.vsix
          bunx ovsx publish dist/stata-workbench-${{ steps.semantic.outputs.new_release_version }}.vsix -p ${{ secrets.OVSX_TOKEN }} || true
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
          OVSX_TOKEN: ${{ secrets.OVSX_TOKEN }}

  publish-targets:
    name: Publish Target Specific VSIXs
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [win32-x64, win32-arm64, linux-x64, linux-arm64, darwin-x64, darwin-arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.release.outputs.new_release_version }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: latest

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Package VSIX
        run: bun run package:target
        env:
          npm_config_target: ${{ matrix.target }}

      - name: Rename VSIX
        run: |
          mkdir -p dist
          mv *.vsix dist/stata-workbench-${{ matrix.target }}.vsix || true

      - name: Publish to VS Code Marketplace
        run: bunx vsce publish --packagePath dist/stata-workbench-${{ matrix.target }}.vsix
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish to Open VSX Registry
        run: bunx ovsx publish dist/stata-workbench-${{ matrix.target }}.vsix -p ${{ secrets.OVSX_TOKEN }}
        continue-on-error: true # OVSX can be flaky

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/stata-workbench-${{ matrix.target }}.vsix
          tag_name: v${{ needs.release.outputs.new_release_version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

