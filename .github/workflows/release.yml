name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    env:
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: latest

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run bundle

      - name: Test
        run: bun run test

      - name: Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        with:
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/git
            @semantic-release/exec
            semantic-release-vsce
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish Universal to VS Code Marketplace
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          # The vsce plugin packages the VSIX in the root when publish is false
          VSIX_PATH=$(ls *.vsix | head -n 1)
          if [ -z "$VSIX_PATH" ]; then
            echo "No VSIX found to publish"
            exit 1
          fi
          
          for i in {1..3}; do
            echo "Attempt $i: Publishing $VSIX_PATH to VS Code Marketplace..."
            bunx vsce publish --packagePath "$VSIX_PATH" && break || {
              if [ $i -lt 3 ]; then
                echo "Publish failed. Retrying in 30 seconds..."
                sleep 30
              else
                echo "Final attempt failed."
                exit 1
              fi
            }
          done
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish to Open VSX
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          echo "Looking for VSIX files..."
          ls -R *.vsix dist/*.vsix 2>/dev/null || echo "No .vsix files found in root or dist/"
          
          # Find the packaged VSIX
          VSIX_PATH=$(find . -maxdepth 2 -name "*.vsix" | head -n 1)
          
          if [ -n "$VSIX_PATH" ] && [ -f "$VSIX_PATH" ]; then
            echo "Publishing $VSIX_PATH to Open VSX..."
            bunx ovsx publish "$VSIX_PATH" -p ${{ secrets.OVSX_TOKEN }}
          else
            echo "Error: No VSIX file found to publish to Open VSX"
            echo "Current directory contents:"
            ls -F
            exit 1
          fi
        env:
          OVSX_TOKEN: ${{ secrets.OVSX_TOKEN }}

  publish-targets:
    name: Publish Target Specific VSIXs
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 2
      matrix:
        target: [win32-x64, win32-arm64, linux-x64, linux-arm64, darwin-x64, darwin-arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.release.outputs.new_release_version }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: latest

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Package VSIX
        run: bun run package:target
        env:
          npm_config_target: ${{ matrix.target }}
          SENTRY_UPLOAD: "false" # Source maps already uploaded by the universal release

      - name: Rename VSIX
        run: |
          mkdir -p dist
          mv *.vsix dist/stata-workbench-${{ matrix.target }}.vsix || true

      - name: Publish to VS Code Marketplace
        run: |
          for i in {1..3}; do
            echo "Attempt $i: Publishing to VS Code Marketplace..."
            bunx vsce publish --packagePath dist/stata-workbench-${{ matrix.target }}.vsix && break || {
              if [ $i -lt 3 ]; then
                echo "Publish failed. Retrying in 30 seconds..."
                sleep 30
              else
                echo "Final attempt failed."
                exit 1
              fi
            }
          done
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish to Open VSX Registry
        run: bunx ovsx publish dist/stata-workbench-${{ matrix.target }}.vsix -p ${{ secrets.OVSX_TOKEN }}
        continue-on-error: true # OVSX can be flaky

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/stata-workbench-${{ matrix.target }}.vsix
          tag_name: v${{ needs.release.outputs.new_release_version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

