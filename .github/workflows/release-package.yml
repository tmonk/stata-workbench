name: Package VSIX on Release

permissions:
  contents: write

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build-and-attach:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Update package-lock.json
        run: npm i --package-lock-only

      - name: Commit updated package-lock.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package-lock.json
          git diff --staged --quiet || git commit -m "Update package-lock.json"
          git push

      - name: Checkout release tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Install dependencies
        run: npm install

      - name: Build VSIX into dist
        run: npm run package:dist

      - name: Publish to Open VSX
        env:
          OVSX_TOKEN: ${{ secrets.OVSX_TOKEN }}
        run: npx ovsx publish dist/stata-workbench-*.vsix -p "$OVSX_TOKEN"
        if: ${{ env.OVSX_TOKEN != '' }}

      - name: Publish to VS Code Marketplace
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: npx vsce publish --packagePath dist/stata-workbench-*.vsix -p "$VSCE_PAT"
        if: ${{ env.VSCE_PAT != '' }}

      - name: Attach VSIX to release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/stata-workbench-*.vsix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
